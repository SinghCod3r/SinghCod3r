name: Update Contributed Organizations

on:
  schedule:
    - cron: "0 */12 * * *"
  workflow_dispatch:

jobs:
  update-orgs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install jq -y

      - name: Fetch PR Events
        run: |
          curl -s -H "Accept: application/vnd.github+json" \
          "https://api.github.com/users/singhcod3r/events/public" \
          | jq -r '
              map(select(.type == "PullRequestEvent")) 
              | group_by(.repo.name | split("/")[0])
              | map({org: .[0].repo.name | split("/")[0], prs: length})
              | .[]
              | "- \(.org) (\(.prs) PRs)"
            ' > orgs.txt

      - name: Update README insert
        run: |
          echo "<!--START_CONTRIBUTIONS-->" > update_section.txt
          cat orgs.txt >> update_section.txt
          echo "<!--END_CONTRIBUTIONS-->" >> update_section.txt

      - name: Replace section in README
        run: |
          awk '
            /<!--START_CONTRIBUTIONS-->/ {print; system("cat update_section.txt"); skip=1; next}
            /<!--END_CONTRIBUTIONS-->/ {skip=0; next}
            !skip
          ' README.md > README_tmp.md && mv README_tmp.md README.md

      - name: Commit & Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ”„ Auto update org contribution stats"
