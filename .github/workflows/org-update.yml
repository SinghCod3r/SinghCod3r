name: Update Contributed Organizations

on:
  schedule:
    - cron: "0 */12 * * *"
  workflow_dispatch:

jobs:
  update-orgs:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install jq -y

      - name: Fetch all PR contributions (open + merged)
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          query='
          {
            user(login: "singhcod3r") {
              pullRequests(first: 100, states: [OPEN, MERGED]) {
                nodes {
                  repository {
                    nameWithOwner
                  }
                }
              }
            }
          }'
          curl -s -H "Authorization: bearer $GH_TOKEN" -X POST \
            -d "{\"query\": \"$query\"}" https://api.github.com/graphql \
            | jq -r '.data.user.pullRequests.nodes[].repository.nameWithOwner | split("/")[0]' \
            | sed "s/.*/\u&/" \
            | sort | uniq -c | awk '{print $2 " : " $1 " PRs"}' \
            > orgs.txt

      - name: Create updated section file
        run: |
          echo "<!--START_CONTRIBUTIONS-->" > update_section.txt
          cat orgs.txt >> update_section.txt
          echo "<!--END_CONTRIBUTIONS-->" >> update_section.txt

      - name: Replace section in README
        run: |
          awk '
            /<!--START_CONTRIBUTIONS-->/ {print; system("cat update_section.txt"); skip=1; next}
            /<!--END_CONTRIBUTIONS-->/ {skip=0; next}
            !skip
          ' README.md > README_tmp.md && mv README_tmp.md README.md

      - name: Commit & Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ”„ Auto update organization contributions"
